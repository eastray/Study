# 2장 테스트

스프링의 핵심인 IoC와 DI는 오브젝트의 설계와 생성, 관계, 사용에 관한 기술이다. 스프링은 IoC/DI를 이용해 객체 지향 프로그래밍 언어의 근본과 가치를 개발자가 손쉽게 적용하고 사용할 수 있게 도와주는 기술이며, 복잡한 엔터프라이즈 어플리케이션을 효과적으로 개발하기 위한 기술이다.

스프링을 잘못 사용한 것인지, 설정에 오류가 있는 것인지, DAO 코드 자체를 잘못 만들었는지 찾아내는데 많은 시간을 사용해야 한다.

만들어진 코드의 기능을 모두 점검할 수 있는 포괄적인 테스트(Compregensive Test)를 만들면, 개발한 어플리케이션은 이후에 어떤 수정에서도 테스트를 모두 돌려보고 안심할 수 있다. 테스트 중 그 변경에 영향을 받는 부분이 정확히 확인된다면 빠르게 조치를 취할 수 있다.

#### 자바 테스팅 프레임워크 JUnit의 두 가지 조건

- 메소드가 public으로 선언돼야 한다.
- 메소드에 @Test 어노테이션을 사용해야 한다.

assertThat() 메소드는 첫 번째 파라미터의 값을 뒤에 나오는 매처(Matcher)라고 불리는 조건으로 비교한다. is() 메소드는 매처의 일종으로 equals()로 비교해주는 기능을 가졌다.

```java
assertThat(device2.getPassword(), is(user.getPassword()));
```

단위 테스트는 항상 일관성 있는 결과가 보장돼야 한다.

테스트 메소드는 한 번에 한 가지 검증 목적에만 충실한 것이 좋다.

@Test 어노테이션의 expected 엘리먼트는 테스트 메소드 실행 중 발생할 것을 기대하는 예외 클래스를 넣는 요소이다. 보통의 테스트와는 달리, 정상적으로 테스트 메소드를 마치면 테스트에 실패하고 expected에서 지정한 예외가 던져지면 테스트가 성공한다.

#### 테스트 주도 개발 (TDD, Test Driven Development)

스프링의 창시자인 로드 존슨은 "항상 네거티브 테스트를 먼저 만들라"는 조언을 했다. 개발자는 빨리 테스트를 만들어 성공하는 것을 보고 다음 기능으로 나아가고 싶어하기 때문에, 긍정적인 경우를 골라서 성공할 만한 테스트를 먼저 작성하게 되기가 쉽다.

만들고자 하는 기능의 내용을 담고 있으면서 만들어진 코드를 검증도 해줄 수 있도록 테스트 코드를 먼저 만들고, 테스트를 성공하게 해주는 코드를 작성하는 방식의 개발 방법을 말한다.

"실패한 테스트를 성공시키기 위한 목적이 아닌 코드는 만들지 않는다."가 TDD의 기본 원칙이다. 이 원칙을 따랐다면 만들어진 모든 코드는 빠짐없이 테스트로 검증된 것이라 할 수 있다.

TDD의 장점 중 하나는 코드를 만들어 테스트를 실행하는 그 사이의 간격이 매우 짧다는 점이다.

#### JUnit이 제공하는 기능

- @Before, @After

프레임워크는 스스로 제어권을 가지고 주도적으로 동작하고, 개발자가 만든 코드는 프레임워크에 의해 수동적으로 실행된다.

JUnit은 @Test가 붙은 메소드를 실행하기 전과 후에 각각 @Before와 @After가 붙은 메소드를 자동으로 실행하다. 보통 하나의 테스트 클래스 안에 있는 테스트 메소드들은 공통적인 주입 작업과 정리 작업이 필요한 경유가 많다.

각 테스트 메소드를 실행할 때마다 테스트 클래스의 오브젝트를 새로 만든다. 한번 만들어진 테스트 클래스의 오브젝트는 하나의 테스트 메소드를 사용하고 나면 버려진다. JUnit 개발자는 각 테스트가 서로 영향을 주지 않고 독립적으로 실행됨을 확실히 보장해주기 위해 매번 새로운 오브젝트를 만들게 했다.

#### 픽스처

테스트를 수행하는데 필요한 정보나 오브젝트를 픽스처(Fixture)라 한다. 일반적으로 픽스처는 여러 테스트에서 반복적으로 사용되기 때문에 @Before 메소드를 이용해 생성해두면 편리하다.

-----

#### @RunWith(SpringJUnit4ClassRunner.class)

@RunWith는 JUnit 프레임워크의 테스트 실행 방법을 확장할 때 사용하는 어노테이션이다. SpringJUnit4ClassRunner라는 JUnit용 테스트 컨텍스트 프레임워크 확장 클래스를 지정해주면 JUnit이 테스트를 진행하는 중에 테스트가 사용할 어플리케이션 컨텍스트를 만들고 관리하는 작업을 진행해준다.

#### @ContextConfiguration(location="/applicationContext.xml")

@ContextConfiguration은 자동으로 만들어줄 어플리케이션 컨텍스트의 설정 파일 위치를 지정한 것이다.

스프링의 JUnit 확장 기능은 테스트가 실행되기 전에 딱 한 번만 어플리케이션 컨텍스트를 만들어주고, 테스 트 오브젝트가 만들어질 때마다 특졀한 방법을 이용해 어플리케이션 컨텍스트 자신을 테스트 오브젝트의 특정 필드에 주입해주는 것이다. 일종의 DI라고 볼 수 있으며, 어플리케이션 오브젝트 사이의 관계를 관리하기 위하 DI와는 상이하다.

#### @Autowired

스프링의 DI에 사용되는 특별한 어노테이션이다. 해당 어노테이션이 붙은 인스턴스 변수가 있으면, 테스트 컨텍스트 프레임워크는 변수 타입과 일치하는 컨텍스트 내의 빈을 찾는다. 타입이 일치하는 빈이 있으면 인스턴스 변수에 주입해준다. 별도의 DI 설정 없이 필드의 타입 정보를 이용해 빈을 자동으로 가져올 수 있으며, 이를 타입에 의한 자동 와이어링이라 한다.

스프링 어플리케이션 컨텍스트는 초기화할 때 자기 자신도 빈으로 등록한다. 따라서 어플리케이션 컨텍스트에는 ApplicationContext 타입의 빈이 존재하며 DI도 가능하다.

```java
@Autowired
private ApplicationContext context;

@Before
public void setUp(){
  this.dao = this.context.getVean("userDao", UserDao.class);
}
```

```java
...
  @Autowired
  SimpleDirverDataSource dataSource;

  pubic class UserDaoTest {
    @Autowired
    userDao dao;
    ...
  }
```

@Autowired를 이용해 어플리케이션 컨텍스트가 갖고 있는 빈을 DI 받을 수 있다면 굳이 컨텍스트를 가져와 getBean()을 사용하는 것이 아닌, 빈을 직접 DI 받을 수 있다. 어플리케이션 컨텍스트를 DI 받아서 다시 DL 방식으로 가져올 때보다 코드가 훨씬 깔끔해진다. @Autowired를 지정하기만 하면 어떤 빈이든 다 가져올 수 있으며, 변수에 할당 가능한 타입을 가진 빈을 자동으로 찾아준다. 단 @Autowired는 같은 타입의 빈이 두 개 이상 있는 경우에는 타입만으로 어떤 빈을 가져올지 결정할 수 없다.

-----

## 학습 테스트로 배우는 스프링

### 학습 테스트

학습 테스트(Learning Test)의 목적은 자신이 사용할 API나 프레임워크의 기능을 테스트로 보면서 사용 방법을 익히려는 것이다. 프레임워크나 기능에 대한 검증이 아닌 기술이나 기능의 이해와 사용 방법을 파악하는데에 목표가 있다.

- 다양한 조건에 따른 기능을 손쉽게 확인해볼 수 있다.

  자동화된 테스트의 모든 장점이 학습 테스트에도 그대로 적용된다. 학습 테스트는 자동화된 테스트 코드로 만들어지기 때문에 다양한 조건에 따라 기능이 어떻게 동작하는지 빠르게 확인할 수 있다.

- 학습 테스트 코드를 개발 중에 참고할 수 있다.

  다양한 기능과 조건에 대한 테스트 코드를 개별적으로 만들고 남겨둘 수 있다. 테스트로 새로운 기술의 다양한 기능을 사용하는 코드를 만들어주면 실제 개발에서 샘플 코드로 참고할 수 있다.

- 프레임워크나 제품을 업그레이드할 때 호환성 검증을 도와준다.

  기존에는 잘 동작하던 기능에 문제가 발생할 수 있으며, 업그레이드 후에 시스템이 미묘한 문제를 일으킬 수 있다. 학습 테스트에 어플리케이션에서 자주 사용하는 기능에 대한 테스트를 만들어놓았다면 새로운 버전의 프레임워크나 제품을 학습 테스트에만 먼저 적용함으로써, 기존에 사용했던 API나 기능에 변화가 있거나 업데이트된 제품에 버그가 있을 경우 학습 테스트를 통해 미리 확인할 수 있다.

- 테스트 작성에 대한 좋은 훈련이 된다.

  프레임워크이 학습 테스트는 실제로 프레임워크를 사용하는 어플리케이션 코드의 테스트와 비슷하다. 또한 학습 테스트는 한, 두가지 간단한 기능에만 초점을 맞추면 되기 때문에 테스트도 대체로 단순한다.

### 버그 테스트

버그 테스트(Bug Test)란 코드에 오류가 있을 때 그 오류를 가장 잘 드러내줄 수 있는 테스트를 말한다. 버그 테스트는 일단 실패하도록 만들고, 버그가 원인이 되서 테스트가 실해하는 코드를 만드는 것이다. 그 후, 테스트가 성공할 수 있도록 어플리케이션 코드를 수정하여 테스트가 성공하면 버그가 해결된 것이다.

- 테스트의 완성도를 높여준다.

  기존 테스트에서 미처 검증하지 못했던 부분이 있기 때문에 오류가 발생한 것이다.

- 버그의 내용을 명확하게 분석하게 해준다.

  예외적인 상황이나 입력 값 때문에 발생하는 오류였다면, 테스트 코드를 만들면서 오류를 발생시키는 값의 범위가 어떤 것인지 분석해볼 기회가 주어진다.

- 기술적인 문제를 해결하는 데 도움이 된다.

  때론 버그의 원인 파악이 힘든 경우가 있다. 또는 기술적으로 다루기 힘든 버그를 발견하는 경우가 있다. 이럴 땐 동일한 문제가 발생하는 가장 단순한 코드와 그에 대한 버그 테스트를 만들어보면 도움이 된다.













