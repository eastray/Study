# ELK Stack (Elasticsearch, Logstash, Kibana Stack)

-----

## index

- Elasticsearch
- Logstash
- Kibana
- Beats 플랫폼

-----

## Elasticsearch

엘라스틱서치(Elasticsearch)는 확장성이 뛰어난 오픈 소스 전체 텍스트 검색 및 분석 엔진이다. 대량의 데이터를 신속하고 거의 실시간으로 저장, 검색 및 분석할 수 있다. 여기서 거의 실시간(NRT, Near Realtime)의 의미는 문서를 색인할 때부터 검색이 가능할 때 까지 걸리는 시간이 1초 정도 됨을 의미한다. 일반적으로 복잡한 검색 기능과 요구 사항이 있는 어플리케이션을 구동하는 기본 엔진/기술로 사용된다.

- 고객이 판매하는 제품을 검색할 수 있는 온라인 웹 스토어에서, 엘라스틱서치는 전체 제품 카탈로그 및 인벤토리를 저장, 검색 및 자동 완성 제안 기능을 제공할 수 있다.
- 로그 또는 트랙젝션 데이터를 수집하고 분석 및 조사함으로써, 추세, 통계, 요약, 예외 등의 정보를 수집하는 경우, 로그스테이시(Elasticsearch/Logstash/Kibana Stack, ELK Stack)를 사용하여 데이터를 수집하고 집계 및 구문 분석 처리 후 엘라스틱서치에게 제공한다. 결과적으로 데이터는 엘라스틱서치에 저장되고, 집계 및 검색을 실행하여 특정 정보를 조회할 수 있다.
- 고객에 어떤 상품에 대해서 특정 가격 이하로 떨어지면 알림을 받고 싶어하는 경우, 공급 업체 가격을 끌어와 엘라스틱서치에 저장하고 역방향 검색(Percolator) 기능을 사용하여 가격 변동을 고객 쿼리와 비교하고 일치하는 항목을 발견할 경우 고객에서 알림을 보낼 수 있다.
- 분석 또는 비즈니스 인텔리전스 요구사항을 갖고, 많은 데이터에 대해 신속하게 조사하거나 분석하거나 시각화하거나 에드혹 질문을 요구한다. 이러한 경우 엘라스틱서치를 사용하여 데이터를 저장한 후, 키바나를 사용하여 중요한 데이터를 시각화 할 수 있는 사용자 정의 대시 보드를 작성할 수 있다. 또한 엘라스틱서치의 집계 기능을 사용하여 데이터에 대한 복잡한 비즈니스 인털레전스 쿼리를 수행할 수 있다.

-----

## Logstash

로그스테이시(Logstash)는 실시간 파이프 라이닝 기능을 갖춘 오픈소스 데이터 수집 엔진이다. 서로 다른 소스의 데이터를 동적으로 통합하여 데이터를 원하는 대상으로 표준화 할 수 있다. 

로그스테이시는 원래 로그 수집에 대한 혁신을 가져왔다. 모든 유형의 이벤트는 광범위한 입력, 필터 및 출력 플러그인으로 풍부해지고 변형 될 수 있으며 많은 원시(native) 코덱을 사용하여 처리 프로세스를 더욱 단순화 한다. 로그스테이시는 많은 양의 다양한 데이터를 활용하여 이해력을 높인다.

- Input: 다양한 형태의 데이터들을 실시간으로 한 곳에 수집 가능
- Filter: 로그를 원하는 형태로 커스터마이징 가능
- Output: 엘라스틱서치, 몽고db, influxDB 등 원하는 곳에 데이터 저장 가능
- PlugIn&Flexibility: 다양한 플러그인을 지원하며, 확장성 향상

### The Power of Oogstash

- 엘라스틱서치와 키바나의 시너지를 통해, 수평적이고 확장 가능한 데이터 처리 라이프 라인


- 다양한 입력, 필터 및 출력을 믹스 또는 매칭 및 조화


- 200개 이상의 플러그인을 사용할 수 있으며, 자신만의 플러그인을 만들고 제공할 수 있는 유연성

![Logstash](./Image/Logstash.png)

### Logs ans Metrics

- 로깅(logging) 데이터의 모든 타입을 처리
  - 아파치와 같은 웹 로그 (log4j)
  - 네트워킹 및 방화벽 로드(syslog)
- Filebeat를 사용한 안정한 로그 전달 기능
- Ganglia, colletta, NetFlow, JMX 및 기타 여러 인프라 및 어플레케이션 플랫폼에서 TCP 및 UDP를 통해 매트릭스 수집

### The Web

- HTTP 요청을 이벤트로 변환
- 필요에 따라 HTTP 엔트 포인트를 폴링함으로써 이벤트 생성
  - 인터페이스의 상태, 성능, 메트릭 및 기타 유형의 데이터를 종합적으로 캡처
  - 수신을 넘어서 폴링의 제어가 선호되는 시나리오에 적합

### Data Stores and Streams 

이미 소유하고 있는 데이터에서 더 많은 가치를 찾을 수 있다.

- JDBC 인터페이스를 사용하여 관계형 데이터베이스 또는 NoSQL 저장소의 데이터를 더 잘 이해 할 수 있다.
- Apache Kafka, RabbitMQ, Amazon SQS와 같은 메시징 큐로부터 다양한 데이터 스트림을 통합할 수 있다.

### Sensors and IoT

다양한 데이터 탐색

- 거대한 IoT 세계에서 연결된 센서의 데이터를 캡처하고 활용함으로써 무한한 유스 케이스를 실현한다.
- 로그스테이시는 모바일 장치에서 인텔리전트 홈, 커넥티드카, 의료 센서 및 기타 여러 산업별 어플리케이션으로 전송되는 데이터 처리를 위한 공통 이벤트 수집 백본이다.

### Easily Enrich Everythingedit

로그스테이시는 패턴 일치, 지오 매핑(geo mapping), 동적 조회 기능과 함께 많은 집계 및 변화를 즉시 사용할 수 있다.

- Grok은 로그스테이시 필터와 밀접한 관계를 갖으며, 구조화되지 않은 데이터에서 구조를 만드는데에 아주 흔하게 사용된다. 웹, 시스템, 네트워킹 및 시타 유형의 이벤트 형식을 신속하게 해결하는데 도움을 준다.
- IP 주소에서 지리적 좌표를 해독하고, 날짜 복잡도를 정규화하고, key - value 또는 CSV 데이터를 단순화하고, 민감하 정보를 핑거프린팅(fingerprinting, anonymizing, 익명 처리)하고 로컹 조회 또는 엘라스틱서치 쿼리로 데이터를 다양하게 함으로써 시야 확장
- 코덱은 JSON 및 멀티라인 이벤트와 같은 공통 이벤트 구조의 처리를 쉽게하기 위해 종종 사용된다.

-----

## Kibana

키바나(Kibana)는 엘라스틱서치와 함께 작동하도록 설계된 오픈소스 분석 및 시각화 플랫폼이다. 엘라스틱서치 색인에 저장된 데이터를 search, view, interact 할 수 있다. 진보된 데이터를 쉽게 분석할 수 있고, 다양한 차트, 테이블 및 맵에서 시각화 할 수 있다.

키바나를 사용하면 많은 양의 데이터를 쉽게 이해할 수 있으며, 간단한 브라우저 기반의 인터페이스를 통해 실시간으로 엘라스틱서치 쿼리의 변경 사항을 표시하는 동적 대시 보드를 신속하게 만들고 공유할 수 있다.

설치가 간단하며, 짧은 시간만에 엘리스틱서치 인덱스를 탐색할 수 있다. 코드 또는 추가적인 인프라가 필요하지 않다.

-----

## Beats 플랫폼

모든 유형의 운영 데이터를 캡처하여 로그스테이시와 엘라스틱서치로 보내는 경량 쉽퍼(Shipper) 역할을 하는 Beats 플랫폼은 Topsbeat, Filebeat, Packetbeat, libbeat 등이 있다. 로그 파일을 경량화하여 엘라스틱서치 또는 로그스테이시로 넘겨주는 역할을 수행하며, 로그스테이스가 과부하되면 넘기는 속도를 줄여주고, 시스템 가동이 중단되거나 재부팅되어도 로그의 중단점을 기억하여 그 시점부터 재전송할 수 있다.

![beats](./Image/beats.png)

### Libbeat

libbeat는 엘라스틱서치로의 벌크 삽입, 로그스테이시로의 안전한 이벤트 전공, 다중 로그스테이시 및 엘라스틱서치 노드로의 이벤트 롣 밸런싱, 동기 및 비동기 보드의 이벤트 전송 등의 역할을 수행하며, 수신 서버의 부하를 감지하거나 서버들 간 네트워크의 혼잡함을 감지하여 전송량을 줄여나가는 메커니즘을 포함한다. 로그스테이시와 엘라스틱서치로 안전하고 효율적으로 이벤트를 보내기 위해 필요한 모든 것을 갖추고 있다.

### Topbeat

모든 서버에 분포되어 있는 최상위 명령이며, 화면에 메트릭을 풀력하는 대신 로그스테이시 또는 엘리스틱서치에 주기적으로 전송하는 방식이다. 시스템 로드, 여유/사용 메모리 또는 디스크 사용량과 같은 시스템 전체 데이터와 프로세스당 메트릭을 중앙에서 관리할 수 있음을 의미한다.

Topbeat는 Linux, OS X, Windows에서 지원 가능하며, 지원 운영체제에 상관없이 네트워크 내 각 서버에 설치하여 동일한 운영체제 매트릭을 수집할 수 있다.

서버에 Topbeat를 설치하면 엘라스틱서치가 설치된 중앙 지점에 주기적으로 메트릭을 전송하기 시작한다. 엘라스틱서치와 함께 키바나를 실행하는 경우에는 시스템 부하, 서버 개요, 시스템 전체 메모리 사용량 또는 CPI 사용량, 최상위 프로세스 목록, 프로세스당 메모리 사용량 또는 CPU 사용량, 디스트 사용 개요 및 디스크 사용량과 같은 위젯들을 사용하여 데이터를 시작화하고 사용자 정의 대시보드를 구성할 수 있다.

![TopbeatOnKibana](./Image/TopbeatOnKibana.png)

### Filebeat

Filebeat는 수년간 많은 기업들이 생산 과정에서 사용해 온 경량 로그 쉽퍼(Shipper)인 Logstash Forwarder의 후속 버전이다. Logstash Forwarder는 추가 처리를 위해 서버의 모든 로그를 중앙 위치로 전달하는 단순 경량 Go 어플리케이션이다.

서버에 Filebeat를 설치한 후 크롤할 경로를 설정하면, 처리를 위해 Logstash를 통해 엘라스틱서치로 로그를 전송한다. 로그 순환, 파일 이름 변경 및 수신 서버의 일시적인 작동 불가 상태 등을 처리할 수 있으며 로그를 안전하게 보호할 수 있다.

Filebeat는 두 가지 요소로 구성되어 있으며, 지정된 파일에 이벤트 데이터를 전송한다.

- harvesters: 단일 파일 내용일 읽는다. 각 harvester는 파일을 한 줄씩 읽은 다음 내용을 출력으로 보낸다. 하나의 harvester가 각 파일에 대해 시작되며, 파일 열기 및 닫기 등을 담당한다. Harvesters가 실행중인 경우 파일 디스크립터가 열린 상태로 유지되며, 파일을 읽는 동안 파일을 제거하거나 이름을 수정해도 파일 읽기는 지속된다. 이는 harvesters가 닫힐 때까지 디스크 공간을 예약하고 있다는 것을 의미한다.
- prospectors: harvesters를 관리하고 출처를 파악하는 역할을 한다. 입력 유형이 log인 경우, 광도계는 정이된 glob 경로와 일치하는 드라이브의 모든 파일을 찾고 각 파일에 대해 harvester를 시작한다. 

![FilebearOnKibana](./Image/FilebearOnKibana.png)

### Packetbeat

최초의 beat로, 각기 다른 프로그래밍 언어, 웹 프레임워크, 데이터베스 등의 분산 시스템에서 일반적으로 HTTP와 같은 표준 프로토콜을 사용할 때, Packetbeat는 요청을 트랜잭션의 응답과 연관시키고 각 트랜잭션에 대한 데이터를 엘라스틱서치에 입력하는 분산형 실시간 패킷 분석 어플리케이션이다. 

Packetbeat는 네트워크 서버 간 통신을 모니터하고, 어플리케이션에 대한 가시성을 제공한다. 네트워크 트래픽을 수동적으로 탐색(Sniffing)한다. 오픈소스이며, 새로운 프로토콜 또는 특정 환경에 국한된 프로토콜까지 지원할 수 있다. 

![PacketbeatOnKivana](./Image/PacketbeatOnKivana.png)

-----

- [Elasticsearch Reference [6.3]](https://www.elastic.co/guide/en/elasticsearch/reference/current/getting-started.html)
- [Logstash Reference [6.3]](https://www.elastic.co/guide/en/logstash/current/introduction.html)
- [Kibana User Guide [6.3]](https://www.elastic.co/guide/en/kibana/current/introduction.html)
- [The Beats 1.0.0](https://www.elastic.co/kr/blog/beats-1-0-0)
- [Installing the ELK Stack on Mac OS X](https://logz.io/blog/elk-mac/)